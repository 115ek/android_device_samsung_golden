From b847d2175875ba31d384b8d3a70aab977ff4f5c7 Mon Sep 17 00:00:00 2001
From: 3liteking148 <harvs89.2@gmail.com>
Date: Sat, 19 Nov 2016 12:19:41 +0800
Subject: [PATCH 2/2] hack offline charging

Change-Id: Icf70c7ddeac4c5955b6debd1b918787ddde11835
---
 healthd/Android.mk |  4 ++--
 init/Android.mk    |  4 +++-
 init/init.cpp      | 17 ++++++++++++++++-
 3 files changed, 21 insertions(+), 4 deletions(-)

diff --git a/healthd/Android.mk b/healthd/Android.mk
index f509ace..b9f5767 100644
--- a/healthd/Android.mk
+++ b/healthd/Android.mk
@@ -70,9 +70,9 @@ ifeq ($(BOARD_USES_QCOM_HARDWARE),true)
 BOARD_HAL_STATIC_LIBRARIES ?= libhealthd.qcom
 endif
 
-# Symlink /charger to /sbin/healthd
+# Symlink /charger to /sbin/charger
 LOCAL_POST_INSTALL_CMD := $(hide) mkdir -p $(TARGET_ROOT_OUT) \
-    && rm -f $(TARGET_ROOT_OUT)/charger && ln -sf /sbin/healthd $(TARGET_ROOT_OUT)/charger
+    && rm -f $(TARGET_ROOT_OUT)/charger && ln -sf /sbin/charger $(TARGET_ROOT_OUT)/charger
 
 include $(BUILD_EXECUTABLE)
 
diff --git a/init/Android.mk b/init/Android.mk
index 7afe762..9115b2b 100644
--- a/init/Android.mk
+++ b/init/Android.mk
@@ -51,7 +51,9 @@ LOCAL_SRC_FILES:= \
 
 SYSTEM_CORE_INIT_DEFINES := BOARD_CHARGING_MODE_BOOTING_LPM \
     BOARD_CHARGING_CMDLINE_NAME \
-    BOARD_CHARGING_CMDLINE_VALUE
+    BOARD_CHARGING_CMDLINE_VALUE \
+    BOARD_LPM_BOOT_ARGUMENT_NAME \
+    BOARD_LPM_BOOT_ARGUMENT_VALUE
 
 $(foreach system_core_init_define,$(SYSTEM_CORE_INIT_DEFINES), \
   $(if $($(system_core_init_define)), \
diff --git a/init/init.cpp b/init/init.cpp
index 402c2c5..4f33814 100644
--- a/init/init.cpp
+++ b/init/init.cpp
@@ -75,6 +75,11 @@ static int property_triggers_enabled = 0;
 #define BOARD_CHARGING_CMDLINE_VALUE "true"
 #endif
 
+#ifndef BOARD_LPM_BOOT_ARGUMENT_NAME
+#define BOARD_LPM_BOOT_ARGUMENT_NAME "lpm_boot"
+#define BOARD_LPM_BOOT_ARGUMENT_VALUE "1"
+#endif
+
 static char qemu[32];
 static char battchg_pause[32];
 
@@ -87,6 +92,8 @@ static time_t process_needs_restart;
 
 static const char *ENV[32];
 
+static unsigned lpm_bootmode = 0;
+
 bool waiting_for_exec = false;
 
 static int epoll_fd = -1;
@@ -792,6 +799,12 @@ static void import_kernel_nv(char *name, bool for_emulator)
 
     if (!strcmp(name,"qemu")) {
         strlcpy(qemu, value, sizeof(qemu));
+#ifdef BOARD_LPM_BOOT_ARGUMENT_NAME
+    } else if (!strcmp(name,BOARD_LPM_BOOT_ARGUMENT_NAME)) {
+        if (!strcmp(value,BOARD_LPM_BOOT_ARGUMENT_VALUE)) {
+            lpm_bootmode = 1;
+        }
+#endif
     } else if (!strcmp(name,BOARD_CHARGING_CMDLINE_NAME)) {
         strlcpy(battchg_pause, value, sizeof(battchg_pause));
     } else if (!strncmp(name, "androidboot.", 12) && name_len > 12) {
@@ -1007,7 +1020,7 @@ static void selinux_initialize(bool in_kernel_domain) {
 
 static int charging_mode_booting(void) {
 #ifndef BOARD_CHARGING_MODE_BOOTING_LPM
-    return 0;
+    return lpm_bootmode;
 #else
     int f;
     char cmb;
@@ -1138,6 +1151,7 @@ int main(int argc, char** argv) {
          strcmp(battchg_pause, BOARD_CHARGING_CMDLINE_VALUE) == 0)
                || charging_mode_booting()) {
         action_for_each_trigger("charger", action_add_queue_tail);
+        init_parse_config_file("/lpm.rc");
     } else if (strncmp(bootmode, "ffbm", 4) == 0) {
         KLOG_ERROR("Booting into ffbm mode\n");
         action_for_each_trigger("ffbm", action_add_queue_tail);
@@ -1178,3 +1192,4 @@ int main(int argc, char** argv) {
 
     return 0;
 }
+
-- 
1.9.1

